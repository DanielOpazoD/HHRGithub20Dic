import React, { useMemo, useState, useCallback } from 'react';
import { useDailyRecordContext } from '../../context/DailyRecordContext';
import { useStaffContext } from '../../context/StaffContext';
import { BEDS } from '../../constants';
import { MessageSquare, Stethoscope, Share2, Send } from 'lucide-react';
import clsx from 'clsx';
import { getShiftSchedule } from '../../utils/dateUtils';

// Sub-components
import { HandoffRow } from './HandoffRow';
import { HandoffChecklistDay } from './HandoffChecklistDay';
import { HandoffChecklistNight } from './HandoffChecklistNight';
import { HandoffNovedades } from './HandoffNovedades';
import { HandoffStaffSelector } from './HandoffStaffSelector';
import { HandoffCudyrPrint } from './HandoffCudyrPrint';
import { HandoffPrintHeader } from './HandoffPrintHeader';
import { HandoffShiftSelector } from './HandoffShiftSelector';
import { MedicalHandoffHeader } from './MedicalHandoffHeader';
import { MovementsSummary } from './MovementsSummary';

import { useNotification } from '@/context/UIContext';
import { useHandoffLogic } from '@/hooks';

interface HandoffViewProps {
    type?: 'nursing' | 'medical';
    readOnly?: boolean;
}

export const HandoffView: React.FC<HandoffViewProps> = ({ type = 'nursing', readOnly = false }) => {
    const {
        record,
        updatePatient,
        updatePatientMultiple,
        updateClinicalCrib,
        updateClinicalCribMultiple,
        updateHandoffChecklist,
        updateHandoffNovedades,
        updateHandoffStaff,
        updateMedicalHandoffDoctor,
        markMedicalHandoffAsSent,
        sendMedicalHandoff
    } = useDailyRecordContext();
    const { nursesList } = useStaffContext();
    const { success } = useNotification();

    const {
        selectedShift,
        setSelectedShift,
        isMedical,
        visibleBeds,
        hasAnyPatients,
        schedule,
        noteField,
        deliversList,
        receivesList,
        tensList,
        handleNursingNoteChange,
        handleShareLink,
        handleSendWhatsAppManual,
        formatPrintDate,
    } = useHandoffLogic({
        record,
        type,
        updatePatient,
        updatePatientMultiple,
        updateClinicalCrib,
        updateClinicalCribMultiple,
        sendMedicalHandoff,
        onSuccess: success,
    });


    const title = isMedical
        ? 'Entrega Turno Médicos'
        : `Entrega Turno Enfermería - ${selectedShift === 'day' ? 'Día' : 'Noche'} `;
    const Icon = isMedical ? Stethoscope : MessageSquare;
    const headerColor = isMedical ? 'text-sky-600' : 'text-medical-600';
    const tableHeaderClass = isMedical
        ? "bg-sky-100 text-sky-900 text-xs uppercase tracking-wider font-semibold border-b border-sky-100"
        : selectedShift === 'day'
            ? "bg-medical-50 text-medical-900 text-xs uppercase tracking-wider font-semibold border-b border-medical-100"
            : "bg-slate-100 text-slate-800 text-xs uppercase tracking-wider font-semibold border-b border-slate-200";

    if (!record) {
        return <div className="p-8 text-center text-slate-500 font-sans">Seleccione una fecha para ver la Entrega de Turno.</div>;
    }

    return (
        <div className="space-y-3 print:space-y-2 animate-fade-in pb-20 font-sans max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 print:max-w-none print:w-full print:px-0 print:pb-0">
            {/* Print-only Header */}
            <HandoffPrintHeader
                title={title}
                dateString={formatPrintDate()}
                Icon={Icon}
                isMedical={isMedical}
                schedule={schedule}
                selectedShift={selectedShift}
                deliversList={deliversList}
                receivesList={receivesList}
                tensList={tensList}
            />

            {/* Main Header (Visible) with integrated Shift Switcher */}
            <header className="bg-white p-3 md:p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row items-center gap-3 print:hidden">
                <div className="flex items-center gap-3">
                    <div className="p-2 bg-indigo-50 rounded-lg">
                        <Icon size={24} className={headerColor} />
                    </div>
                    <div>
                        <h2 className="text-xl font-bold text-slate-800">
                            {isMedical ? 'Entrega de Turno' : 'Entrega de Turno Enfermería'}
                        </h2>
                        {!isMedical && (
                            <p className="text-sm text-slate-500 font-medium">
                                {selectedShift === 'day'
                                    ? `Turno Largo(${schedule.dayStart} - ${schedule.dayEnd})`
                                    : `Turno Noche(${schedule.nightStart} - ${schedule.nightEnd})`
                                }
                            </p>
                        )}
                    </div>
                </div>

                {/* Shift Switcher - Only Nursing */}
                {!isMedical && (
                    <div className="md:mx-auto">
                        <HandoffShiftSelector
                            selectedShift={selectedShift}
                            onShiftChange={setSelectedShift}
                            schedule={schedule}
                        />
                    </div>
                )}

                {/* Medical Action Buttons */}
                {isMedical && !readOnly && (
                    <div className="flex items-center gap-2 md:ml-auto">
                        <button
                            onClick={handleSendWhatsAppManual}
                            disabled={!!record.medicalSignature}
                            className={clsx(
                                "flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors",
                                record.medicalSignature
                                    ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                                    : "bg-green-500 text-white hover:bg-green-600"
                            )}
                            title="Enviar entrega por WhatsApp (Manual)"
                        >
                            <Send size={14} /> Enviar por WhatsApp
                        </button>
                        <button
                            onClick={handleShareLink}
                            className="flex items-center gap-2 px-3 py-1.5 bg-sky-100 text-sky-700 rounded-lg hover:bg-sky-200 transition-colors text-xs font-bold"
                            title="Generar link para firma del médico"
                        >
                            <Share2 size={14} />
                        </button>
                    </div>
                )}
            </header>

            {/* Medical Handoff Header (Doctor to Doctor) */}
            {isMedical && (
                <MedicalHandoffHeader
                    record={record}
                    visibleBeds={visibleBeds}
                    readOnly={readOnly}
                    updateMedicalHandoffDoctor={updateMedicalHandoffDoctor}
                    markMedicalHandoffAsSent={markMedicalHandoffAsSent}
                />
            )}

            {/* Clinical Checklists & Staff (Monitor view + Print) */}
            {!isMedical && (
                <div className="flex flex-col gap-4">
                    {/* Top Row: Staff Selectors (Side by Side) - HIDDEN IN PRINT */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 print:hidden">
                        <HandoffStaffSelector
                            label="Entrega"
                            type="delivers"
                            bgClass="bg-white"
                            selectedNurses={deliversList}
                            availableNurses={nursesList}
                            onUpdate={(list) => updateHandoffStaff(selectedShift, 'delivers', list)}
                            readOnly={readOnly}
                        />
                        <HandoffStaffSelector
                            label="Recibe"
                            type="receives"
                            bgClass="bg-white"
                            selectedNurses={receivesList}
                            availableNurses={nursesList}
                            onUpdate={(list) => updateHandoffStaff(selectedShift, 'receives', list)}
                            readOnly={readOnly}
                        />
                    </div>

                    {/* Bottom Row: Checklist */}
                    <div>
                        {selectedShift === 'day' ? (
                            <HandoffChecklistDay
                                data={record.handoffDayChecklist}
                                onUpdate={(field, val) => updateHandoffChecklist('day', field, val)}
                                readOnly={readOnly}
                            />
                        ) : (
                            <HandoffChecklistNight
                                data={record.handoffNightChecklist}
                                onUpdate={(field, val) => updateHandoffChecklist('night', field, val)}
                                readOnly={readOnly}
                            />
                        )}
                    </div>
                </div>
            )}

            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden print:shadow-none print:border-none print:rounded-none print:overflow-visible">
                <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse print:[&_th]:p-1 print:[&_td]:p-1 print:[&_th]:text-[10px] print:[&_td]:text-[10px]">
                        <thead>
                            <tr className={tableHeaderClass}>
                                <th className="p-2 border-r border-slate-200 text-center w-20 print:w-[40px] print:text-[10px] print:p-1">Cama</th>
                                <th className="p-2 border-r border-slate-200 min-w-[150px] print:w-[15%] print:text-[10px] print:p-1">Nombre Paciente</th>
                                <th className="p-2 border-r border-slate-200 w-36 print:hidden">RUT</th>
                                <th className="p-2 border-r border-slate-200 w-64 print:w-[12%] print:text-[10px] print:p-1">Diagnóstico</th>
                                <th className="p-2 border-r border-slate-200 w-20 print:w-[50px] print:text-[10px] print:p-1">Estado</th>
                                <th className="p-2 border-r border-slate-200 w-28 text-center print:hidden">F. Ingreso</th>
                                <th className="p-2 border-r border-slate-200 w-20 print:w-[55px] print:text-[10px] print:p-1" title="Dispositivos médicos invasivos">DMI</th>
                                <th className="p-2 min-w-[300px] print:w-auto print:text-[10px] print:p-1">Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {visibleBeds.map(bed => {
                                const patient = record.beds[bed.id];

                                return (
                                    <React.Fragment key={bed.id}>
                                        <HandoffRow
                                            bedName={bed.name}
                                            bedType={bed.type}
                                            patient={patient}
                                            reportDate={record.date}
                                            noteField={noteField}
                                            onNoteChange={(val) => handleNursingNoteChange(bed.id, val, false)}
                                            readOnly={readOnly}
                                        />

                                        {patient.clinicalCrib && patient.clinicalCrib.patientName && (
                                            <HandoffRow
                                                bedName={bed.name}
                                                bedType="Cuna"
                                                patient={patient.clinicalCrib}
                                                reportDate={record.date}
                                                isSubRow={true}
                                                noteField={noteField}
                                                onNoteChange={(val) => handleNursingNoteChange(bed.id, val, true)}
                                                readOnly={readOnly}
                                            />
                                        )}
                                    </React.Fragment>
                                );
                            })}

                            {/* If no occupied beds found */}
                            {!hasAnyPatients && (
                                <tr>
                                    <td colSpan={10} className="p-8 text-center text-slate-400 italic text-sm">
                                        No hay pacientes registrados en este turno.
                                    </td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            <div className="hidden print:block print:h-4" aria-hidden="true" />{/* Print-only spacer */}

            {/* Additional Sections for Nursing Handoff (Altas, Traslados, CMA) */}
            {!isMedical && <MovementsSummary record={record} />}

            {/* Novedades Section */}
            {!isMedical && (
                <HandoffNovedades
                    value={selectedShift === 'day' ? (record.handoffNovedadesDayShift || '') : (record.handoffNovedadesNightShift || '')}
                    onChange={(val) => updateHandoffNovedades(selectedShift, val)}
                />
            )}

            {/* Novedades Section - Medical */}
            {isMedical && (
                <HandoffNovedades
                    value={record.medicalHandoffNovedades || ''}
                    onChange={(val) => updateHandoffNovedades('medical', val)}
                />
            )}

            {/* CUDYR - Night Nursing Print Only */}
            {!isMedical && selectedShift === 'night' && (
                <div className="print:break-before-page">
                    <HandoffCudyrPrint />
                </div>
            )}
        </div>
    );
};
